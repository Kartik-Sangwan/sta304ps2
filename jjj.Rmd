---
title: "go"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tinytex)
library(tidyverse)
library(visdat)
library(cesR)
library(skimr)
library(rmarkdown)
library(stringr)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
cesR::get_decon()
total <- 37822
age <- decon %>% select("yob") %>% mutate(age = 2020 - as.numeric(as.character(yob)))
age_cat <- age %>% mutate(age_group = case_when(age >= 18 & age <= 30 ~ 1, age >= 31 & age <= 40 ~ 2, age >= 41 & age <= 50 ~ 3, age >= 51 & age <= 60 ~ 4, age >= 61 & age <= 70 ~ 5, age>=71 ~ 6))
gender_weights <- decon %>% count(gender)
province_weights <- decon %>% count(province_territory)
education_weights <- decon %>% count(education)
education_weights <- c(522, 7514, 12096, 12908, 4782)
income_cat_weights <- decon %>% count(income_cat) %>% add_row("income_cat" = "prefer not to answer", n = 28453)
income_cat_weights <- income_cat_weights[-c(9, 10),]
age_group_weights <- age_cat %>% count(age_group)
# fix this later
first_time_voter_weight <- c(ceiling(0.2*total), ceiling(0.8*total) - 1)
decided_to_vote <- c(29346, 8476)
# fake improve later on
ethnicity <- c(ceiling(0.05*total)-1, ceiling(0.12*total)-1, ceiling(0.04*total)-1, ceiling(0.26*total), ceiling(0.34*total), ceiling(0.09*total), ceiling(0.1*total))
# from wikipedia
last_election_vote <- data.frame(party = c("The Liberal Party of Canada", "The Conservative Party of Canada", "The Green Party of Canada", "New Democratic Party (NDP)", "Bloc Québécois", "People's Party of Canada (PPC)", "I voted for an independent politician", "None of the above"), votes = c(ceiling(0.45*total)-1, ceiling(0.35*total)-1, ceiling(0.009*total)-1, ceiling(0.07*total), ceiling(0.09*total), ceiling(0.01*total), ceiling(0.01*total)-1, ceiling(0.011*total)))

temp <- rnorm(8, 0, 2)
preference_weights <- c(0.36, 0.24, 0.1, 0.08, 0.02, 0.16, 0.02, 0.02)

# convert rep to SRS
# creating the dataset from our survey using real world parameters and cesR data
survey_responses <- data.frame(gender = sample(c("Male", "Female", "LGBTQ"), total, replace = TRUE, prob = gender_weights$n), 
                               age = sample(c("18-30", "31-40", "41-50", "51-60", "61-70", "71+"), total, TRUE,age_group_weights$n), 
                               first_time_vote = sample(c("YES", "NO"),total, TRUE, first_time_voter_weight),
                               decided_to_vote = sample(c("YES", "NO"),total,TRUE, decided_to_vote),
                               education = sample(c("None", "High School", "College/Diploma", "University (Bachelor's Degree)", "University (Master's/PhD)"),total,TRUE, education_weights),
                               salary = sample(c("No income", "$1 to $30,000", "$30,001 to $60,000", "$60,001 to $90,000", "$90,001 to $110,000", "$110,001 to $150,000", "$150,001 to $200,000", "More than $200,000", "Don't know/ Prefer not to answer"),total, TRUE, income_cat_weights$n),
                               province = sample(c("Alberta", "British Columbia", "Manitoba", "New Brunswick", "Newfoundland and Labrador" , "Northwest Territories", "Nova Scotia", "Nunavut", "Ontario", "Prince Edward Island", "Quebec", "Saskatchewan", "Yukon"),total, TRUE, province_weights$n),
                               last_election_vote = sample( c("The Liberal Party of Canada", "The Conservative Party of Canada", "The Green Party of Canada", "New Democratic Party (NDP)", "Bloc Québécois", "People's Party of Canada (PPC)", "I voted for an independent politician", "None of the above"),total,TRUE, last_election_vote$votes),
                               ethnicity = sample(c("Caucasian", "African", "Hispanic or Latino", "East Asian", "South Asian", "I am one of the Indigenous Peoples of Canada", "Other"), total, TRUE, ethnicity),
                               current_preference = sample(c("The Liberal Party of Canada", "The Conservative Party of Canada", "The Green Party of Canada", "New Democratic Party (NDP)", "Bloc Québécois", "People's Party of Canada (PPC)", "I voted for an independent politician", "None of the above"),total,TRUE, preference_weights)
                               )

# shuffling the rows 
survey_data <- survey_responses[sample(nrow(survey_responses)),]

head(survey_data)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
# STRATIFICATION BY PROVINCE
survey_data <- arrange(survey_data, province)
survey_data <- survey_data %>% mutate(id = row_number())
last_rows <- survey_data %>% group_by(province) %>% summarise_all(last)
last_rows

provinces_row_numbers <- data.frame(province = c("Alberta", "British Columbia", "Manitoba", "New Brunswick", "Newfoundland and Labrador" , "Northwest Territories", "Nova Scotia", "Nunavut", "Ontario", "Prince Edward Island", "Quebec", "Saskatchewan", "Yukon"), row_num = last_rows$id)

# doing simple random sampling in each of the 13 strata 
i <- 0
# total number of stratified SRS
required <- 3000

province_strat_res <- data.frame(gender = NA, 
                  age = NA, 
                  first_time_vote = NA,
                  decided_to_vote = NA,
                  education = NA,
                  salary = NA,
                  province = NA,
                  last_election_vote = NA,
                  ethnicity = NA,
                  current_preference = NA,
                  id = NA
                 )

set.seed(1001)
i <- 0
p <- 1
for (ind in provinces_row_numbers$row_num){
  print(paste("new strata for:", provinces_row_numbers$province[p]))
  prop = (ind - i)/37822
  rows <- sample_n(survey_data[i:ind,], ceiling(prop*required))
  province_strat_res <- rbind(province_strat_res, rows)
  print(rows)
  i = ind
  p <- p + 1
}

province_strat_res
province_strat_res <- cbind(a = 1, province_strat_res)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
